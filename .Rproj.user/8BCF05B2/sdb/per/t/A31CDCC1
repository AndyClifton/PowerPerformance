{
    "contents" : "rm(list = ls())\n## DIRECTORIES ----\n# where do I keep my projects?\nproject.dir = '/Users/aclifton/Documents/public/projects'\n# where in that directory, is this particular project?\nproject.dir = file.path(project.dir,'PRUF/models')\n# where's the data, relative to the project directory?\ndata.dir = file.path(project.dir,'data')\nfigure.dir = file.path(project.dir,'figures')\n\n# where do I keep all of my R functions?\ncode.dir = '/Users/aclifton/Documents/public/code/R/windnrg/'\n\n## MODEL VALUES ----\n# Financial\nyearsToBuild = 2\nperiods = 20\ndiscountRate = 3.5\n# Renewable energy system cost and performance\nplantSize = 100 #MW\ncostPerMW = 2000000 # $/MW\ncapacityFactor = 38 #%\nfixedOandM = 40000 #$/Mw-yr\nvariableOandM = 2 #$/MWh\n# income\nelectricPrice = 30 #$/MW\nescalationRate = 3 # %/yr\nPTC = 2.3 # c/kWhr\nnYearsPTC = 10\n\n## END OF USER INPUTS\n\n## CODE STARTS HERE ----\n# other settings\nworking.dir = project.dir\nsetwd(working.dir)\nSys.setenv(TZ='GMT')\n\n# packages\nrequire(\"ggplot2\")\nrequire(\"reshape2\")\nrequire(scales)\n\n# START OF CASHFLOW CALCULATION ----\n# interest rate\nirate <- discountRate/100;\n\n# empty variables\nproduction <- NULL\ncosts <- NULL\ndiscount <- NULL\nincome <- NULL\nfor (year in seq(-yearsToBuild,periods,1)){\n  \n  ## DISCOUNT RATE FOR THIS YEAR\n  year.from.start = year + yearsToBuild\n  discount.new <- data.frame(year = year,\n                             year.from.start = year.from.start,\n                             discount.factor = (1+discountRate/100)^year.from.start)\n  \n  ## PRODUCTION\n  if (year >= 0){\n    # MWhr production\n    production.nominal <- plantSize * (8760 * (capacityFactor/100))\n    production.losses <- -0\n  } else {\n    production.nominal = 0\n    production.losses <- -0\n  }\n  \n  # NOTE: need the production to estimate variable O&M costs.\n  # can also include losses here, if required.\n  \n  ## COSTS\n  # investment costs\n  if (year < 0){\n    invt = (plantSize * costPerMW)/yearsToBuild\n  } else {\n    invt = 0\n  }\n  \n  # O&M costs\n  if (year >= 0){\n    fixedOandMt <- fixedOandM\n    variableOandMt <- variableOandM * production.nominal\n  } else {\n    fixedOandMt <- 0\n    variableOandMt <- 0\n  }\n  \n  # INCOME\n  if (year >= 0){\n    electricSales <- (production.nominal + production.losses) * \n      electricPrice * (1+escalationRate/100)^year.from.start\n    if (year < nYearsPTC){\n      # $/MWhr\n      PTCincome <- ((PTC/100)*1000) * (production.nominal + production.losses)\n    } else {\n      PTCincome <- 0\n    }\n  } else {\n    electricSales <- 0\n    PTCincome <- 0\n  }\n  \n  # RETURN DATA\n  # save the discount rates\n  discount <- rbind(discount,\n                    discount.new)\n  # save the different costs\n  costs.new <- data.frame(investment = invt,\n                          fixedOandM = fixedOandMt,\n                          variableOandM = variableOandMt)\n  costs <- rbind(costs,\n                 costs.new)\n  # save different production terms\n  production.new <-data.frame(nominal = production.nominal,\n                              losses = production.losses)\n  production <- rbind(production,\n                      production.new)\n  # save different income terms\n  income.new <- data.frame(electricSales = electricSales,\n                           PTC = PTCincome)\n  income <- rbind(income,\n                  income.new)\n}\n\n# roll up income\nincome.discounted <- income / discount$discount.factor\ntotal.income<- data.frame(year = discount$year,\n                          actual = apply(income, 1, sum),\n                          discounted = apply(income.discounted, 1, sum))\n\n# roll up costs\ncosts.discounted <- costs / discount$discount.factor\ntotal.costs<- data.frame(year = discount$year,\n                         actual = apply(costs, 1, sum),\n                         discounted = apply(costs.discounted, 1, sum))\n\n# roll up production\nproduction.discounted <- production / discount$discount.factor\ntotal.production <- data.frame(year = discount$year,\n                               actual = apply(production, 1, sum),\n                               discounted = apply(production.discounted, 1, sum))\n\n# NPV\nnpv <- data.frame(year = discount$year,\n                  year.from.start = discount$year.from.start,\n                  per.year = apply(income.discounted, 1, sum) - apply(costs.discounted, 1, sum))\nnpv$cumulative <- cumsum(npv$per.year)\n\n## CASHFLOW\ncashflow <- data.frame(year = discount$year,\n                       year.from.start = discount$year.from.start,\n                       cbind(income, -costs))\ncashflow.discounted <- data.frame(year = discount$year,\n                                  year.from.start = discount$year.from.start,\n                                  cbind(income.discounted, -costs.discounted))\n\n# plot the cashflow\np.cashflow <- ggplot(data = melt(data.frame(year = discount$year,\n                                            year.from.start = discount$year.from.start,\n                                            cbind(income.discounted)),\n                                 id.vars = c(\"year\",\"year.from.start\")),\n                     aes(x = year,\n                         y = value/1000)) +\n  geom_bar(stat = \"identity\",position = \"stack\",           \n           aes(fill = variable)) +\n  geom_bar(data = melt(data.frame(year = discount$year,\n                                  year.from.start = discount$year.from.start,\n                                  cbind(-costs.discounted)),\n                       id.vars = c(\"year\",\"year.from.start\")),\n           aes(fill = variable),\n           stat = \"identity\",position = \"stack\") +\n  geom_line(data = melt(npv,\n                        id.vars = c(\"year\",\"year.from.start\")),\n            aes(colour = variable)) +\n  scale_y_continuous(name = \"Discounted value ($1,000s)\",\n                     labels = comma)\nprint(p.cashflow)\nggsave(file = file.path(figure.dir,\"cashflow.png\"),\n       plot = cleanPlot(p.cashflow,\n                        base.size = 8),\n       width=6, height=4, dpi=300)\n\n# LCOE estimate\nLCOEout <- sum(total.costs$discounted)/sum(total.production$discounted)\ncat(LCOEout, \"\\n\")\n\n",
    "created" : 1406303457609.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "354032264",
    "id" : "A31CDCC1",
    "lastKnownWriteTime" : 1406246686,
    "path" : "~/Documents/public/projects/PRUF/Models/Cashflow_toy.R",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}